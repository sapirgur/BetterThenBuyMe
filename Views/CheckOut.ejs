<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>עמוד התשלום</title>
    <link rel="icon" href="/css/Images/gifty/gifty_card.png" type="image/png">
    <!-- Bootstrap CSS -->
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" href="/css/all.min.css">
    <link rel="stylesheet" href="/css/CheckOut.css">
</head>
<body class="bg-light">
    
    <div class="container">
        <main>
            <div class="py-5 text-center">
                <h2>עמוד התשלום</h2>
                <p class="lead">הזן את פרטי התשלום והמשלוח שלך להשלמת ההזמנה.</p>
            </div>

            <div class="row g-5">
                <div class="col-md-7 col-lg-8">
                    <h4 class="mb-3">פרטי חיוב</h4>
                    <form id="checkoutForm" class="needs-validation" novalidate method="POST" action="/CheckOut">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <label for="firstName" class="form-label">שם פרטי</label>
                                <input type="text" class="form-control" id="firstName" placeholder="" value="<%= user.name.split(' ')[0] %>" required pattern="^[א-תA-Za-z]+$" title="יש להזין שם המכיל תווים בעברית או באנגלית בלבד.">
                                <div class="invalid-feedback">
                                    נדרש שם פרטי חוקי.
                                </div>
                                <div id="firstNameError" class="error"></div>
                            </div>

                            <div class="col-sm-6">
                                <label for="lastName" class="form-label">שם משפחה</label>
                                <input type="text" class="form-control" id="lastName" placeholder="" value="<%= user.name.split(' ')[1] %>" required pattern="^[א-תA-Za-z]+$" title="יש להזין שם משפחה המכיל תווים בעברית או באנגלית בלבד.">
                                <div class="invalid-feedback">
                                    נדרש שם משפחה חוקי.
                                </div>
                                <div id="lastNameError" class="error"></div>
                            </div>

                            <div class="col-12">
                                <label for="username" class="form-label">שם משתמש</label>
                                <div class="input-group has-validation">
                                    <input type="text" class="form-control" id="username" placeholder="שם משתמש" value="<%= user.email.split('@')[0] %>" required pattern="^[A-Za-z0-9_]+$" title="יש להזין שם משתמש המכיל תווים באנגלית בלבד.">
                                    <div class="invalid-feedback">
                                        שם משתמש נדרש.
                                    </div>
                                </div>
                                <div id="usernameError" class="error"></div>
                            </div>

                            <div class="col-12">
                                <label for="email" class="form-label">דוא"ל <span class="text-muted">(לא חובה)</span></label>
                                <input type="email" class="form-control" id="email" placeholder="אימייל" value="<%= user.email %>">
                                <div class="invalid-feedback">
                                    הזן כתובת דוא"ל חוקית עבור עדכוני משלוח.
                                </div>
                                <div id="emailError" class="error"></div>
                            </div>

                            <div class="col-12">
                                <label for="address" class="form-label">כתובת</label>
                                <input type="text" class="form-control" id="address" placeholder="כתובת למשלוח" required>
                                <div class="invalid-feedback">
                                    הזן כתובת למשלוח.
                                </div>
                                <div id="addressError" class="error"></div>
                            </div>

                            <div class="col-md-4">
                                <label for="state" class="form-label">עיר</label>
                                <select class="form-select" id="state" required>
                                    <option value="">בחר</option>
                                    <option>אום אל-פחם</option>
                                    <option>אופקים</option>
                                    <option>אור יהודה</option>
                                    <option>אור עקיבא</option>
                                    <option>אילת</option>
                                    <option>אלעד</option>
                                    <option>אריאל</option>
                                    <option>אשדוד</option>
                                    <option>אשקלון</option>
                                    <option>באקה אל-גרביה</option>
                                    <option>באר שבע</option>
                                    <option>בית שאן</option>
                                    <option>בית שמש</option>
                                    <option>ביתר עילית</option>
                                    <option>בני ברק</option>
                                    <option>בת ים</option>
                                    <option>גבעת שמואל</option>
                                    <option>גבעתיים</option>
                                    <option>דימונה</option>
                                    <option>הוד השרון</option>
                                    <option>הרצליה</option>
                                    <option>חדרה</option>
                                    <option>חולון</option>
                                    <option>חיפה</option>
                                    <option>טבריה</option>
                                    <option>טייבה</option>
                                    <option>טירה</option>
                                    <option>טירת כרמל</option>
                                    <option>יבנה</option>
                                    <option>יהוד-מונוסון</option>
                                    <option>יקנעם עילית</option>
                                    <option>ירושלים</option>
                                    <option>כפר יונה</option>
                                    <option>כפר סבא</option>
                                    <option>כפר קאסם</option>
                                    <option>כרמיאל</option>
                                    <option>לוד</option>
                                    <option>מגדל העמק</option>
                                    <option>מודיעין-מכבים-רעות</option>
                                    <option>מודיעין עילית</option>
                                    <option>מעלה אדומים</option>
                                    <option>מעלות-תרשיחא</option>
                                    <option>נהריה</option>
                                    <option>נס ציונה</option>
                                    <option>נצרת</option>
                                    <option>נצרת עילית</option>
                                    <option>נשר</option>
                                    <option>נתיבות</option>
                                    <option>נתניה</option>
                                    <option>סחנין</option>
                                    <option>עכו</option>
                                    <option>עפולה</option>
                                    <option>עראבה</option>
                                    <option>ערד</option>
                                    <option>פתח תקווה</option>
                                    <option>צפת</option>
                                    <option>קלנסווה</option>
                                    <option>קריית אונו</option>
                                    <option>קריית ארבע</option>
                                    <option>קריית אתא</option>
                                    <option>קריית ביאליק</option>
                                    <option>קריית גת</option>
                                    <option>קריית ים</option>
                                    <option>קריית מוצקין</option>
                                    <option>קריית מלאכי</option>
                                    <option>קריית שמונה</option>
                                    <option>ראש העין</option>
                                    <option>ראשון לציון</option>
                                    <option>רחובות</option>
                                    <option>רמלה</option>
                                    <option>רמת גן</option>
                                    <option>רמת השרון</option>
                                    <option>רעננה</option>
                                    <option>שדרות</option>
                                    <option>שפרעם</option>
                                    <option>תל אביב</option>
                                    <option>תל אביב-יפו</option>
                                    <option>תל מונד</option>
                                </select>
                                <div class="invalid-feedback">
                                    בחר עיר חוקית.
                                </div>
                                <div id="stateError" class="error"></div>
                            </div>

                            <div class="col-md-3">
                                <label for="zip" class="form-label">מיקוד</label>
                                <input type="text" class="form-control" id="zip" placeholder="" pattern="^\d{5,7}$" title="יש להזין מיקוד חוקי בעל 5 עד 7 ספרות">
                                <div class="invalid-feedback">
                                    מיקוד נדרש.
                                </div>
                                <div id="zipError" class="error"></div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="same-address">
                            <label class="form-check-label" for="same-address">כתובת למשלוח זהה לכתובת החיוב</label>
                        </div>
                        <hr class="my-4">

                        <h4 class="mb-3">תשלום</h4>

                        <div class="my-3">
                            <div class="form-check">
                                <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked required>
                                <label class="form-check-label" for="credit">כרטיס אשראי</label>
                            </div>
                            <div class="form-check">
                                <input id="debit" name="paymentMethod" type="radio" class="form-check-input" required>
                                <label class="form-check-label" for="debit">כרטיס דביט</label>
                            </div>
                        </div>

                        <div class="row gy-3">
                            <div class="col-md-6">
                                <label for="cc-name" class="form-label">שם על הכרטיס</label>
                                <input type="text" class="form-control" id="cc-name" name="ccName" placeholder="" required pattern="^[א-תA-Za-z\s]+$" title="יש להזין שם בעל הכרטיס בעברית או באנגלית בלבד">
                                <small class="text-muted">השם המלא שמופיע על הכרטיס</small>
                                <div class="invalid-feedback">
                                    שם בעל הכרטיס נדרש.
                                </div>
                                <div id="ccNameError" class="error"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="cc-number" class="form-label">מספר כרטיס אשראי</label>
                                <input type="text" class="form-control" id="cc-number" name="ccNumber" placeholder="" required pattern="^\d{16}$" title="יש להזין 16 ספרות של מספר כרטיס האשראי">
                                <div class="invalid-feedback">
                                    מספר כרטיס האשראי נדרש.
                                </div>
                                <div id="ccNumberError" class="error"></div>
                            </div>

                            <div class="col-md-3">
                                <label for="cc-expiration" class="form-label">תוקף</label>
                                <input type="text" class="form-control" id="cc-expiration" name="ccExpiration" placeholder="MM/YY" required pattern="^(0[1-9]|1[0-2])\/[0-9]{2}$" title="יש להזין תוקף בפורמט MM/YY">
                                <div class="invalid-feedback">
                                    תאריך התוקף נדרש.
                                </div>
                                <div id="ccExpirationError" class="error"></div>
                            </div>

                            <div class="col-md-3">
                                <label for="cc-cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cc-cvv" name="ccCvv" placeholder="" required pattern="^\d{3,4}$" title="יש להזין קוד CVV בן 3 או 4 ספרות">
                                <div class="invalid-feedback">
                                    קוד ה-CVV נדרש.
                                </div>
                                <div id="ccCvvError" class="error"></div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="rememberCardInfo" name="rememberCardInfo">
                            <label class="form-check-label" for="rememberCardInfo">זכור את פרטי הכרטיס לפעם הבאה</label>
                        </div>

                        <hr class="my-4">

                        <button id="checkoutButton" class="w-100 btn btn-primary btn-lg" type="button">המשך לתשלום</button>
                    </form>
                </div>
                <div class="col-md-5 col-lg-4 order-md-last">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-primary">הסל שלך</span>
                        <span class="badge bg-primary rounded-pill"><%= cart.length %></span>
                    </h4>
                    <ul class="list-group mb-3">
                        <% if (cart.length > 0) { %>
                            <% cart.forEach(function(item) { %>
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0"><%= item.product_name %></h6>
                                        <small class="text-muted">כמות: <%= item.quantity %></small>
                                    </div>
                                    <span class="text-muted">₪<%= item.price %></span>
                                </li>
                            <% }); %>
                        <% } else { %>
                            <li class="list-group-item d-flex justify-content-between lh-sm">
                                <div>
                                    <h6 class="my-0">אין פריטים בסל</h6>
                                </div>
                            </li>
                        <% } %>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>סה"כ </span>
                            <strong>₪<%= cart.reduce((total, item) => total + item.price * item.quantity, 0) %></strong>
                        </li>
                    </ul>

                    <form class="card p-2" id="coupon-form">
                        <div class="input-group">
                            <input type="text" class="form-control" id="coupon-code" placeholder="קוד הנחה">
                            <button type="submit" class="btn btn-secondary">ממש</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderSuccessModalLabel">הזמנה הצליחה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    תודה לך על ההזמנה! ההזמנה שלך הושלמה בהצלחה.
                </div>
                <div class="modal-footer">
                    <button id="closeModalButton" type="button" class="btn btn-primary" data-bs-dismiss="modal">סגור</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle JS -->
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Form Validation JS -->
    <script>
        document.getElementById('checkoutButton').addEventListener('click', function(event) {
            var firstName = document.getElementById('firstName');
            var lastName = document.getElementById('lastName');
            var username = document.getElementById('username');
            var email = document.getElementById('email');
            var address = document.getElementById('address');
            var state = document.getElementById('state');
            var zip = document.getElementById('zip');
            var ccName = document.getElementById('cc-name');
            var ccNumber = document.getElementById('cc-number');
            var ccExpiration = document.getElementById('cc-expiration');
            var ccCvv = document.getElementById('cc-cvv');

            var firstNamePattern = /^[א-תA-Za-z]+$/;
            var lastNamePattern = /^[א-תA-Za-z]+$/;
            var usernamePattern = /^[A-Za-z0-9_]+$/;
            var zipPattern = /^\d{5,7}$/;
            var ccNamePattern = /^[א-תA-Za-z\s]+$/;
            var ccNumberPattern = /^\d{16}$/;
            var ccExpirationPattern = /^(0[1-9]|1[0-2])\/[0-9]{2}$/;
            var ccCvvPattern = /^\d{3,4}$/;

            var valid = true;

            if (!firstNamePattern.test(firstName.value)) {
                firstName.setCustomValidity('יש להזין שם המכיל תווים בעברית או באנגלית בלבד.');
                document.getElementById('firstNameError').innerText = firstName.validationMessage;
                valid = false;
            } else {
                firstName.setCustomValidity('');
                document.getElementById('firstNameError').innerText = '';
            }

            if (!lastNamePattern.test(lastName.value)) {
                lastName.setCustomValidity('יש להזין שם משפחה המכיל תווים בעברית או באנגלית בלבד.');
                document.getElementById('lastNameError').innerText = lastName.validationMessage;
                valid = false;
            } else {
                lastName.setCustomValidity('');
                document.getElementById('lastNameError').innerText = '';
            }

            if (!usernamePattern.test(username.value)) {
                username.setCustomValidity('יש להזין שם משתמש המכיל תווים באנגלית בלבד.');
                document.getElementById('usernameError').innerText = username.validationMessage;
                valid = false;
            } else {
                username.setCustomValidity('');
                document.getElementById('usernameError').innerText = '';
            }

            if (!zipPattern.test(zip.value)) {
                zip.setCustomValidity('יש להזין מיקוד חוקי בעל 5 עד 7 ספרות.');
                document.getElementById('zipError').innerText = zip.validationMessage;
                valid = false;
            } else {
                zip.setCustomValidity('');
                document.getElementById('zipError').innerText = '';
            }

            if (!ccNamePattern.test(ccName.value)) {
                ccName.setCustomValidity('יש להזין שם בעל הכרטיס בעברית או באנגלית בלבד.');
                document.getElementById('ccNameError').innerText = ccName.validationMessage;
                valid = false;
            } else {
                ccName.setCustomValidity('');
                document.getElementById('ccNameError').innerText = '';
            }

            if (!ccNumberPattern.test(ccNumber.value)) {
                ccNumber.setCustomValidity('יש להזין 16 ספרות של מספר כרטיס האשראי.');
                document.getElementById('ccNumberError').innerText = ccNumber.validationMessage;
                valid = false;
            } else {
                ccNumber.setCustomValidity('');
                document.getElementById('ccNumberError').innerText = '';
            }

            if (!ccExpirationPattern.test(ccExpiration.value)) {
                ccExpiration.setCustomValidity('יש להזין תוקף בפורמט MM/YY.');
                document.getElementById('ccExpirationError').innerText = ccExpiration.validationMessage;
                valid = false;
            } else {
                ccExpiration.setCustomValidity('');
                document.getElementById('ccExpirationError').innerText = '';
            }

            if (!ccCvvPattern.test(ccCvv.value)) {
                ccCvv.setCustomValidity('יש להזין קוד CVV בן 3 או 4 ספרות.');
                document.getElementById('ccCvvError').innerText = ccCvv.validationMessage;
                valid = false;
            } else {
                ccCvv.setCustomValidity('');
                document.getElementById('ccCvvError').innerText = '';
            }

            if (state.value === '') {
                state.setCustomValidity('יש לבחור עיר.');
                document.getElementById('stateError').innerText = state.validationMessage;
                valid = false;
            } else {
                state.setCustomValidity('');
                document.getElementById('stateError').innerText = '';
            }

            if (!valid) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                var orderSuccessModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                orderSuccessModal.show();
            }

            firstName.reportValidity();
            lastName.reportValidity();
            username.reportValidity();
            email.reportValidity();
            address.reportValidity();
            state.reportValidity();
            zip.reportValidity();
            ccName.reportValidity();
            ccNumber.reportValidity();
            ccExpiration.reportValidity();
            ccCvv.reportValidity();
        });

        document.getElementById('closeModalButton').addEventListener('click', function() {
            document.getElementById('checkoutForm').submit();
        });

        document.getElementById('coupon-form').addEventListener('submit', function(event) {
            event.preventDefault();
        
            const couponCode = document.getElementById('coupon-code').value;
            console.log('Coupon Code:', couponCode);
        
            fetch('/verify-coupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ couponCode: couponCode }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response Data:', data);
                if (data.valid) {
                    const discountPercentage = data.discountPercentage;
                    const totalElement = document.querySelector('.list-group-item strong');
                    const total = parseFloat(totalElement.textContent.replace('₪', ''));
                    const discountedTotal = total - (total * discountPercentage / 100);
                    totalElement.textContent = `₪${discountedTotal.toFixed(2)}`;
                } else {
                    alert('קוד הנחה לא תקין');
                }
            })
            .catch(error => {
                console.error('Error verifying coupon:', error);
            });
        });
    </script>
</body>
</html>
